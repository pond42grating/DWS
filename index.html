<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User and Admin Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .input-section, .auth-section, .details-section {
      margin-bottom: 15px;
    }
    .hidden {
      display: none;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>

  <h1>User Registration and Admin Control</h1>

  <!-- Authentication Section (Sign-In and Sign-Up) -->
  <div id="authSection">
    <div class="auth-section">
      <h2>Sign Up</h2>
      <label for="signupUsername">Username:</label>
      <input type="text" id="signupUsername" placeholder="Enter Username" required><br><br>

      <label for="signupPassword">Password:</label>
      <input type="password" id="signupPassword" placeholder="Enter Password" required><br><br>

      <button id="signupBtn">Sign Up</button>
      <p class="error" id="signupError"></p>
    </div>

    <div class="auth-section">
      <h2>Sign In</h2>
      <label for="signinUsername">Username:</label>
      <input type="text" id="signinUsername" placeholder="Enter Username" required><br><br>

      <label for="signinPassword">Password:</label>
      <input type="password" id="signinPassword" placeholder="Enter Password" required><br><br>

      <button id="signinBtn">Sign In</button>
      <p class="error" id="signinError"></p>
    </div>
  </div>

  <!-- Admin Login Section -->
  <div id="adminSection" class="hidden">
    <h2>Admin Login</h2>
    <label for="adminUsername">Admin Username:</label>
    <input type="text" id="adminUsername" placeholder="Enter Admin Username" required><br><br>

    <label for="adminPassword">Admin Password:</label>
    <input type="password" id="adminPassword" placeholder="Enter Admin Password" required><br><br>

    <button id="adminLoginBtn">Login as Admin</button>
    <p class="error" id="adminError"></p>
  </div>

  <!-- Admin Dashboard (After Admin Login) -->
  <div id="adminDashboard" class="hidden">
    <h2>Admin Dashboard</h2>
    <h3>Sign-Up Requests</h3>
    <ul id="signupRequestsList"></ul>
  </div>

  <!-- Main App (Visible After User Sign-In) -->
  <div id="mainApp" class="hidden">
    <h1>Welcome to the Project Data Management App</h1>
    <button id="logoutBtn">Logout</button>

    <div id="projectSection">
      <h2>Enter Project Information</h2>

      <!-- Project data entry form -->
      <label for="structureName">Structure Name:</label>
      <input type="text" id="structureName" placeholder="Enter Structure Name" required><br><br>

      <label for="work">Work:</label>
      <input type="text" id="work" placeholder="Enter Work" required><br><br>

      <label for="location">Location:</label>
      <input type="text" id="location" placeholder="Enter Location" required><br><br>

      <label for="manpower">Manpower:</label>
      <button id="addManpowerBtn">Add Manpower</button><br><br>

      <label for="equipment">Equipment:</label>
      <button id="addEquipmentBtn">Add Equipment</button><br><br>

      <label for="materials">Materials:</label>
      <button id="addMaterialsBtn">Add Materials</button><br><br>

      <button id="saveDataBtn">Save Data</button>

      <h3>Saved Data:</h3>
      <table id="savedDataTable">
        <thead>
          <tr>
            <th>Structure Name</th>
            <th>Work</th>
            <th>Location</th>
            <th>Manpower</th>
            <th>Equipment</th>
            <th>Materials</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="exportBtn">Export to Excel</button>
    </div>
  </div>

  <script>
    let users = JSON.parse(localStorage.getItem("users")) || [];
    let projectData = JSON.parse(localStorage.getItem("projectData")) || [];
    let adminLoggedIn = false;
    let currentUser = null;

    const signupBtn = document.getElementById("signupBtn");
    const signinBtn = document.getElementById("signinBtn");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const saveDataBtn = document.getElementById("saveDataBtn");
    const exportBtn = document.getElementById("exportBtn");

    const signupUsername = document.getElementById("signupUsername");
    const signupPassword = document.getElementById("signupPassword");
    const signinUsername = document.getElementById("signinUsername");
    const signinPassword = document.getElementById("signinPassword");
    const adminUsername = document.getElementById("adminUsername");
    const adminPassword = document.getElementById("adminPassword");

    const structureName = document.getElementById("structureName");
    const work = document.getElementById("work");
    const location = document.getElementById("location");
    const manpower = document.getElementById("manpower");
    const equipment = document.getElementById("equipment");
    const materials = document.getElementById("materials");

    const signupError = document.getElementById("signupError");
    const signinError = document.getElementById("signinError");
    const adminError = document.getElementById("adminError");

    const authSection = document.getElementById("authSection");
    const adminSection = document.getElementById("adminSection");
    const adminDashboard = document.getElementById("adminDashboard");
    const mainApp = document.getElementById("mainApp");
    const savedDataTable = document.getElementById("savedDataTable").getElementsByTagName('tbody')[0];

    const signupRequestsList = document.getElementById("signupRequestsList");

    // Check if the user is an admin or a registered user
    const checkAdminAccess = () => {
      if (adminLoggedIn) {
        authSection.classList.add("hidden");
        adminSection.classList.add("hidden");
        adminDashboard.classList.remove("hidden");
        displaySignupRequests();
      } else {
        adminSection.classList.remove("hidden");
      }
    };

    // Display signup requests in the admin dashboard
    const displaySignupRequests = () => {
      signupRequestsList.innerHTML = '';
      users.forEach((user, index) => {
        if (!user.isApproved) {
          const listItem = document.createElement("li");
          listItem.textContent = `Username: ${user.username}`;
          listItem.innerHTML += ` <button onclick="approveSignup(${index})">Approve</button>`;
          listItem.innerHTML += ` <button onclick="rejectSignup(${index})">Reject</button>`;
          signupRequestsList.appendChild(listItem);
        }
      });
    };

    // Approve a user signup
    const approveSignup = (index) => {
      users[index].isApproved = true;
      localStorage.setItem("users", JSON.stringify(users));
      displaySignupRequests();
    };

    // Reject a user signup
    const rejectSignup = (index) => {
      users.splice(index, 1);
      localStorage.setItem("users", JSON.stringify(users));
      displaySignupRequests();
    };

    // Sign up a new user
    signupBtn.addEventListener("click", () => {
      const username = signupUsername.value.trim();
      const password = signupPassword.value.trim();
      const existingUser = users.find(user => user.username === username);

      if (existingUser) {
        signupError.textContent = "Username already exists!";
      } else {
        const newUser = {
          username,
          password,
          isApproved: false,
        };
        users.push(newUser);
        localStorage.setItem("users", JSON.stringify(users));
        signupError.textContent = "Sign up successful. Awaiting approval from the admin.";
        signupUsername.value = "";
        signupPassword.value = "";
      }
    });

    // Sign in an existing user
    signinBtn.addEventListener("click", () => {
      const username = signinUsername.value.trim();
      const password = signinPassword.value.trim();
      const user = users.find(user => user.username === username && user.password === password && user.isApproved);

      if (user) {
        currentUser = user;
        authSection.classList.add("hidden");
        mainApp.classList.remove("hidden");
        displaySavedData();
      } else {
        signinError.textContent = "Invalid credentials or account not approved by admin.";
      }
    });

    // Admin login
    adminLoginBtn.addEventListener("click", () => {
      const username = adminUsername.value.trim();
      const password = adminPassword.value.trim();

      // Admin credentials check
      if (username === "heyman" && password === "12345678") {
        adminLoggedIn = true;
        checkAdminAccess();
      } else {
        adminError.textContent = "Invalid Admin credentials.";
      }
    });

    // Log out
    logoutBtn.addEventListener("click", () => {
      authSection.classList.remove("hidden");
      mainApp.classList.add("hidden");
      adminDashboard.classList.add("hidden");
      signinUsername.value = "";
      signinPassword.value = "";
      currentUser = null;
    });

    // Save project data
    saveDataBtn.addEventListener("click", () => {
      const project = {
        structureName: structureName.value.trim(),
        work: work.value.trim(),
        location: location.value.trim(),
        manpower: manpower.value.trim(),
        equipment: equipment.value.trim(),
        materials: materials.value.trim(),
      };

      if (project.structureName && project.work && project.location) {
        projectData.push(project);
        localStorage.setItem("projectData", JSON.stringify(projectData));

        // Clear the form fields
        structureName.value = "";
        work.value = "";
        location.value = "";
        manpower.value = "";
        equipment.value = "";
        materials.value = "";

        displaySavedData();
      } else {
        alert("Please fill out all required fields.");
      }
    });

    // Display saved data in the table
    function displaySavedData() {
      savedDataTable.innerHTML = "";
      projectData.forEach(project => {
        const row = savedDataTable.insertRow
                const row = savedDataTable.insertRow();
        row.insertCell(0).textContent = project.structureName;
        row.insertCell(1).textContent = project.work;
        row.insertCell(2).textContent = project.location;
        row.insertCell(3).textContent = project.manpower;
        row.insertCell(4).textContent = project.equipment;
        row.insertCell(5).textContent = project.materials;
      });
    }

    // Export to Excel
    exportBtn.addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(projectData);
      XLSX.utils.book_append_sheet(wb, ws, "Project Data");

      // Download the Excel file
      XLSX.writeFile(wb, "ProjectData.xlsx");
    });

    // Initial check if admin or user is logged in
    if (adminLoggedIn) {
      checkAdminAccess();
    }
  </script>
</body>
</html>