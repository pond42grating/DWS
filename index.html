<script>
    // Function to parse CSV data with proper handling of double quotes
    function parseCSV(content) {
        const rows = [];
        const lines = content.split('\n');

        lines.forEach(line => {
            const values = [];
            let value = '';
            let insideQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (insideQuotes && line[i + 1] === '"') {
                        // Handle escaped double quotes ("")
                        value += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle insideQuotes state
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    // End of a value
                    values.push(value.trim());
                    value = '';
                } else {
                    // Regular character
                    value += char;
                }
            }

            // Add the last value in the line
            values.push(value.trim());
            rows.push(values);
        });

        return rows;
    }

    document.getElementById('upload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const content = e.target.result;

            // Parse the CSV content
            const rows = parseCSV(content);

            console.log("Parsed Rows:", rows);

            // Manpower (Rows 17-36, Columns 2-6)
            populateManpower(rows.slice(16, 36));

            // Equipment (Rows 42-51, Columns 2 and 5)
            populateEquipment(rows.slice(41, 51));

            // Materials (Rows 56-65, Columns 2, 6, and 9)
            populateMaterials(rows.slice(55, 65));
        };
        reader.readAsText(file);
    });

    function sanitizeText(text) {
        if (text === undefined || text === null) return '';
        return text.replace(/[“”]/g, '"').replace(/[^\x00-\x7F]/g, "").trim();
    }

    // Populate the Manpower table (Rows 17-36, Columns 2-6)
    function populateManpower(data) {
        const table = document.getElementById("manpower-table").querySelector("tbody");
        table.innerHTML = ''; // Clear existing rows
        data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><input type="text" value="${sanitizeText(row[1])}"></td> <!-- Column 2: Trade -->
                <td><input type="text" value="${sanitizeText(row[2])}"></td> <!-- Column 3: Name -->
                <td><input type="text" value="${sanitizeText(row[3])}"></td> <!-- Column 4: Badge Number -->
                <td><input type="text" value="${sanitizeText(row[4])}"></td> <!-- Column 5: Normal Hours -->
                <td><input type="text" value="${sanitizeText(row[5])}"></td> <!-- Column 6: Overtime -->
                <td><input type="text" value="${sanitizeText(row[6])}"></td> <!-- Column 7: Holiday -->
            `;
            table.appendChild(tr);
        });
    }

    // Populate the Equipment table (Rows 42-51, Columns 2 and 5)
    function populateEquipment(data) {
        const table = document.getElementById("equipment-table").querySelector("tbody");
        table.innerHTML = ''; // Clear existing rows
        data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><input type="text" value="${sanitizeText(row[1])}"></td> <!-- Column 2: Equipment Name -->
                <td><input type="text" value="${sanitizeText(row[4])}"></td> <!-- Column 5: Working Hours -->
            `;
            table.appendChild(tr);
        });
    }

    // Populate the Materials table (Rows 56-65, Columns 2, 6, and 9)
    function populateMaterials(data) {
        const table = document.getElementById("materials-table").querySelector("tbody");
        table.innerHTML = ''; // Clear existing rows
        data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><input type="text" value="${sanitizeText(row[1])}"></td> <!-- Column 2: Description -->
                <td><input type="text" value="${sanitizeText(row[5])}"></td> <!-- Column 6: Quantity -->
                <td><input type="text" value="${sanitizeText(row[8])}"></td> <!-- Column 9: Unit -->
            `;
            table.appendChild(tr);
        });
    }
</script>