<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLSX to CSV Converter</title>
</head>
<body>
    <h1>XLSX to CSV Converter</h1>
    <input type="file" id="fileInput" accept=".xlsx" />
    <button onclick="convertToCSV()">Convert and Download CSV</button>

    <script>
        async function convertToCSV() {
            const fileInput = document.getElementById("fileInput");

            if (!fileInput.files.length) {
                alert("Please select an XLSX file to convert.");
                return;
            }

            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();

            // Step 1: Extract the XLSX file (ZIP format)
            const zip = new Uint8Array(arrayBuffer);
            const unzippedFiles = extractZip(zip);

            // Step 2: Locate the `xl/worksheets/sheet1.xml` file
            const sheetXML = unzippedFiles["xl/worksheets/sheet1.xml"];
            if (!sheetXML) {
                alert("Cannot find sheet1.xml in the XLSX file.");
                return;
            }

            // Step 3: Parse the sheet XML
            const csvData = parseSheetXML(sheetXML);

            // Step 4: Trigger CSV file download
            downloadCSV(csvData, "output.csv");
        }

        // Function to extract ZIP content manually (simplified, not implemented)
        function extractZip(zipData) {
            const files = {}; // Example: {"xl/worksheets/sheet1.xml": "<xml data>"}
            // Manual ZIP extraction logic should go here
            console.error("Manual ZIP extraction is extremely complex and not implemented here.");
            return files; // Placeholder
        }

        // Function to parse the XML content of a sheet
        function parseSheetXML(sheetXML) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(sheetXML, "application/xml");
            const rows = xmlDoc.getElementsByTagName("row");
            const csvData = [];

            for (let row of rows) {
                const cells = row.getElementsByTagName("c");
                const rowData = [];
                for (let cell of cells) {
                    const value = cell.getElementsByTagName("v")[0]?.textContent || "";
                    rowData.push(value);
                }
                csvData.push(rowData.join(","));
            }

            return csvData.join("\n");
        }

        // Function to download CSV data as a file
        function downloadCSV(data, filename) {
            const blob = new Blob([data], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>