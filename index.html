<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Data Management</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .input-section {
      margin-bottom: 15px;
    }
    .details-section {
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Project Information</h1>

  <!-- Input Fields for Project Data -->
  <div class="input-section">
    <label for="structureName">Structure Name:</label>
    <input type="text" id="structureName" placeholder="Enter Structure Name" required><br><br>

    <label for="work">Work:</label>
    <input type="text" id="work" placeholder="Enter Work" required><br><br>

    <label for="location">Location:</label>
    <input type="text" id="location" placeholder="Enter Location" required><br><br>

    <!-- Buttons for Adding Manpower, Equipment, and Materials -->
    <button id="addManpowerBtn">Add Manpower</button>
    <button id="addEquipmentBtn">Add Equipment</button>
    <button id="addMaterialBtn">Add Material</button>
    <br><br>

    <button id="saveData">Save Data</button>
  </div>

  <!-- Hidden Sections for Manpower, Equipment, and Material Input -->
  <div id="manpowerSection" class="hidden">
    <h3>Manpower Details</h3>
    <label for="manpowerBadge">Badge Number:</label>
    <input type="text" id="manpowerBadge" required><br><br>
    
    <label for="manpowerName">Name:</label>
    <input type="text" id="manpowerName" required><br><br>

    <label for="manpowerJob">Job Title:</label>
    <input type="text" id="manpowerJob" required><br><br>

    <label for="manpowerHours">Normal Hours Worked:</label>
    <input type="number" id="manpowerHours" required><br><br>

    <label for="manpowerOvertime">Overtime Hours:</label>
    <input type="number" id="manpowerOvertime" required><br><br>

    <label for="manpowerHoliday">Holiday Hours:</label>
    <input type="number" id="manpowerHoliday" required><br><br>

    <button id="saveManpower">Save Manpower</button>
  </div>

  <div id="equipmentSection" class="hidden">
    <h3>Equipment Details</h3>
    <label for="equipmentName">Equipment Name:</label>
    <input type="text" id="equipmentName" required><br><br>
    
    <label for="equipmentQty">Quantity:</label>
    <input type="number" id="equipmentQty" required><br><br>

    <button id="saveEquipment">Save Equipment</button>
  </div>

  <div id="materialSection" class="hidden">
    <h3>Material Details</h3>
    <label for="materialName">Material Name:</label>
    <input type="text" id="materialName" required><br><br>
    
    <label for="materialQty">Quantity:</label>
    <input type="number" id="materialQty" required><br><br>

    <button id="saveMaterial">Save Material</button>
  </div>

  <h2>Saved Data:</h2>
  <ul id="userList"></ul>

  <!-- Search Functionality -->
  <div>
    <label for="searchName">Search by Structure Name:</label>
    <input type="text" id="searchName">
    <button id="searchUser">Search</button>
  </div>

  <!-- Export Buttons -->
  <button id="exportConsolidated">Export Consolidated Data</button>
  <button id="exportFiltered">Export Filtered Data</button>
  
  <script>
    // Initialize savedData from localStorage
    let savedData = JSON.parse(localStorage.getItem("projectData")) || [];

    // Function to display saved data
    const displayData = () => {
      const userList = document.getElementById("userList");
      userList.innerHTML = ""; // Clear existing list
      savedData.forEach((data, index) => {
        const listItem = document.createElement("li");
        listItem.textContent = `Structure: ${data.StructureName}, Work: ${data.Work}, Location: ${data.Location}`;
        listItem.innerHTML += ` <button onclick="exportData(${index})">Export Data</button>`;
        userList.appendChild(listItem);
      });
    };

    // Function to handle saving data
    document.getElementById("saveData").addEventListener("click", () => {
      const structureName = document.getElementById("structureName").value.trim();
      const work = document.getElementById("work").value.trim();
      const location = document.getElementById("location").value.trim();

      if (!structureName || !work || !location) {
        alert("Please fill in all fields!");
        return;
      }

      const project = { 
        StructureName: structureName, 
        Work: work, 
        Location: location, 
        Manpower: [], 
        Equipment: [], 
        Materials: [] 
      };

      savedData.push(project);
      localStorage.setItem("projectData", JSON.stringify(savedData));

      displayData();

      // Clear input fields
      document.getElementById("structureName").value = "";
      document.getElementById("work").value = "";
      document.getElementById("location").value = "";
    });

    // Search functionality
    document.getElementById("searchUser").addEventListener("click", () => {
      const searchName = document.getElementById("searchName").value.trim().toLowerCase();
      const result = savedData.filter(data => data.StructureName.toLowerCase().includes(searchName));

      const searchResultDiv = document.getElementById("searchResult");
      searchResultDiv.innerHTML = ""; // Clear previous results

      if (result.length > 0) {
        result.forEach((data) => {
          const div = document.createElement("div");
          div.textContent = `Found: ${data.StructureName} - Work: ${data.Work}`;
          searchResultDiv.appendChild(div);
        });
      } else {
        searchResultDiv.textContent = "No matching records found.";
      }
    });

    // Export data to Excel (consolidated)
    document.getElementById("exportConsolidated").addEventListener("click", () => {
      const ws = XLSX.utils.json_to_sheet(savedData.map(data => ({
        StructureName: data.StructureName,
        Work: data.Work,
        Location: data.Location,
        Manpower: JSON.stringify(data.Manpower),
        Equipment: JSON.stringify(data.Equipment),
        Materials: JSON.stringify(data.Materials)
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Project Data");
      XLSX.writeFile(wb, "consolidated_project_data.xlsx");
    });

    // Export filtered data to Excel (based on search)
    document.getElementById("exportFiltered").addEventListener("click", () => {
      const searchName = document.getElementById("searchName").value.trim().toLowerCase();
      const filteredData = savedData.filter(data => data.StructureName.toLowerCase().includes(searchName));

      const ws = XLSX.utils.json_to_sheet(filteredData.map(data => ({
        StructureName: data.StructureName,
        Work: data.Work,
        Location: data.Location,
        Manpower: JSON.stringify(data.Manpower),
        Equipment: JSON.stringify(data.Equipment),
        Materials: JSON.stringify(data.Materials)
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Filtered Project Data");
      XLSX.writeFile(wb, `filtered_project_data_${searchName}.xlsx`);
    });

    // Export individual data
    function exportData(index) {
      const ws = XLSX.utils.json_to_sheet([savedData[index]]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Project Data");
      XLSX.writeFile(wb, `${savedData[index].StructureName}_project_data.xlsx`);
    }

    // Toggle visibility of sections
    document.getElementById("addManpowerBtn").addEventListener("click", () => {
      document.getElementById("manpowerSection").classList.toggle("hidden");
    });

    document.getElementById("addEquipmentBtn").addEventListener("click", () => {
      document.getElementById("equipmentSection").classList.toggle("hidden");
    });

    document.getElementById("addMaterialBtn").addEventListener("click", () => {
      document.getElementById("materialSection").classList.toggle("hidden");
    });

    // Save manpower data
    document.getElementById("saveManpower").addEventListener("click", () => {
      const badgeNumber = document.getElementById("manpowerBadge").value.trim();
      const name = document.getElementById("manpowerName").value.trim();
      const jobTitle = document.getElementById("manpowerJob").value.trim();
      const normalHours = document.getElementById("manpowerHours").value.trim();
      const overtime = document.getElementById("manpowerOvertime").value.trim();
      const holiday = document.getElementById("manpowerHoliday").value.trim();

      const manpower = { BadgeNumber: badgeNumber, Name: name, JobTitle: jobTitle, NormalHours: normalHours, Overtime: overtime, Holiday: holiday };

      const lastIndex = savedData.length - 1;
      savedData[lastIndex].Manpower.push(manpower);
      localStorage.setItem("projectData", JSON.stringify(savedData));

      document.getElementById("manpowerBadge").value = "";
      document.getElementById("manpowerName").value = "";
      document.getElementById("manpowerJob").value = "";
      document.getElementById("manpowerHours").value = "";
      document.getElementById("manpowerOvertime").value = "";
      document.getElementById("manpowerHoliday").value = "";
    });

    // Save equipment data
    document.getElementById("saveEquipment").addEventListener("click", () => {
      const name = document.getElementById("equipmentName").value.trim();
      const qty = document.getElementById("equipmentQty").value.trim();

      const equipment = { Name: name, Quantity: qty };

      const lastIndex = savedData.length - 1;
      savedData[lastIndex].Equipment.push(equipment);
      localStorage.setItem("projectData", JSON.stringify(savedData));

      document.getElementById("equipmentName").value = "";
      document.getElementById("equipmentQty").value = "";
    });

    // Save material data
    document.getElementById("saveMaterial").addEventListener("click", () => {
      const name = document.getElementById("materialName").value.trim();
      const qty = document.getElementById("materialQty").value.trim();

      const material = { Name: name, Quantity: qty };

      const lastIndex = savedData.length - 1;
      savedData[lastIndex].Materials.push(material);
      localStorage.setItem("projectData", JSON.stringify(savedData));

      document.getElementById("materialName").value = "";
      document.getElementById("materialQty").value = "";
    });

    // Initialize data display
    displayData();
  </script>
</body>
</html>